name: Deploy OPA to SKS

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'infra/k8s/**'
      - '.github/workflows/deploy-opa.yml'

jobs:
  deploy-opa:
    runs-on: ubuntu-latest

    env:
      # JFROG_TOKEN is your JFrog access token (Bearer)
      JFROG_TOKEN: ${{ secrets.JFROG_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Recreate kubeconfig from secret
        env:
          KUBECONFIG_B64: ${{ secrets.EXOSCALE_KUBECONFIG_B64 }}
        run: |
          echo "$KUBECONFIG_B64" | base64 -d > kubeconfig
          echo "KUBECONFIG=$PWD/kubeconfig" >> $GITHUB_ENV

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.30.0'

      - name: Define kubectl retry helper
        run: |
          cat << 'EOF' > kubectl_retry.sh
          #!/usr/bin/env bash
          set -euo pipefail
          cmd="$@"
          for i in {1..5}; do
            echo "Attempt $i: kubectl $cmd"
            if kubectl $cmd; then
              echo "kubectl $cmd succeeded"
              exit 0
            fi
            echo "kubectl $cmd failed, retrying in 10s..."
            sleep 10
          done
          echo "kubectl $cmd failed after 5 attempts"
          exit 1
          EOF
          chmod +x kubectl_retry.sh

      - name: Check cluster connectivity
        run: |
          ./kubectl_retry.sh cluster-info --request-timeout=60s
          ./kubectl_retry.sh get nodes --request-timeout=60s

      - name: Install / Update / Verify ingress-nginx controller
        run: |
          ./kubectl_retry.sh -n ingress-nginx rollout status daemonset/ingress-nginx-controller --timeout=300s || \
          ./kubectl_retry.sh -n ingress-nginx rollout status deployment/ingress-nginx-controller --timeout=300s

      - name: Apply OPA namespace
        run: |
          ./kubectl_retry.sh apply --validate=false --request-timeout=60s -f k8s/namespace-opa.yaml

      - name: Create / update JFrog secret
        run: |
          # Render secret manifest to a file, then apply with retries
          cat <<EOF > jfrog-secret.yaml
          apiVersion: v1
          kind: Secret
          metadata:
            name: jfrog-credentials
            namespace: opa
          type: Opaque
          stringData:
            JFROG_TOKEN: "${JFROG_TOKEN}"
          EOF

          ./kubectl_retry.sh apply --validate=false --request-timeout=60s -f jfrog-secret.yaml

      - name: Apply OPA K8s manifests
        run: |
          ./kubectl_retry.sh apply --validate=false --request-timeout=60s -f infra/k8s/opa-config.yaml
          ./kubectl_retry.sh apply --validate=false --request-timeout=60s -f infra/k8s/opa-deployment.yaml
          ./kubectl_retry.sh apply --validate=false --request-timeout=60s -f infra/k8s/opa-ingress.yaml

      - name: Show status
        run: |
          ./kubectl_retry.sh -n opa get pods,svc,ingress --request-timeout=60s
          ./kubectl_retry.sh -n ingress-nginx get svc --request-timeout=60s
